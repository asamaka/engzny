<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screenshot Intelligence Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      color-scheme: dark;
      --bg: #0b0f16;
      --panel: rgba(18, 24, 36, 0.8);
      --panel-solid: #121824;
      --border: rgba(255, 255, 255, 0.08);
      --text: #e8edf7;
      --text-dim: #a2aec2;
      --accent: #7bdcff;
      --accent-strong: #5ed1ff;
      --glow: rgba(123, 220, 255, 0.3);
      --success: #8ee89d;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #131a2b 0%, #0b0f16 60%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 1.25rem;
      width: 100%;
    }

    .stage {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: #0f1522;
      border: 1px solid var(--border);
      min-height: 60vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stage img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .stage .placeholder {
      color: var(--text-dim);
      font-size: 0.95rem;
      text-align: center;
      padding: 2rem;
      max-width: 320px;
    }

    .scanning-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(9, 13, 22, 0.15) 0%, rgba(9, 13, 22, 0.6) 100%);
      backdrop-filter: blur(6px);
      transition: opacity 0.4s ease;
    }

    .scanning-overlay.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .scanner-bar {
      position: absolute;
      left: 5%;
      right: 5%;
      height: 6px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      box-shadow: 0 0 20px var(--glow);
      border-radius: 999px;
      animation: scan 3s ease-in-out infinite;
    }

    @keyframes scan {
      0% { top: 10%; opacity: 0.2; }
      50% { top: 80%; opacity: 0.8; }
      100% { top: 10%; opacity: 0.2; }
    }

    .scan-status {
      padding: 1rem 1.5rem;
      background: rgba(14, 19, 30, 0.7);
      border: 1px solid rgba(123, 220, 255, 0.2);
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .scan-status h2 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-strong);
      margin-bottom: 0.25rem;
    }

    .scan-status p {
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .intel-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .glass {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.25rem;
      backdrop-filter: blur(14px);
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-strong);
    }

    .hero-title {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .hero-subtitle {
      font-size: 0.9rem;
      color: var(--text-dim);
    }

    .hero-image {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #0b101c;
    }

    .hero-image img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
    }

    #intel-feed {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .intel-card {
      background: var(--panel-solid);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      animation: slideUp 0.45s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(12px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .metric-subtext {
      color: var(--text-dim);
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.85rem;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item.active {
      color: var(--success);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .grid-cell {
      padding: 0.75rem;
      border-radius: 12px;
      background: rgba(17, 24, 38, 0.8);
      border: 1px solid var(--border);
    }

    .grid-cell.dark {
      background: #0b111b;
    }

    .footer-actions {
      display: flex;
      gap: 0.75rem;
    }

    .footer-actions button {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      padding: 0.7rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: border 0.2s ease, background 0.2s ease;
    }

    .footer-actions button.primary {
      background: var(--accent-strong);
      color: #05121c;
      border: none;
      font-weight: 600;
    }

    .footer-actions button:hover {
      border-color: rgba(123, 220, 255, 0.4);
    }

    .footer-note {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 0.5rem;
    }

    .upload-fallback {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .upload-fallback input,
    .upload-fallback button {
      width: 100%;
    }

    .upload-fallback input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.6rem 0.75rem;
      color: var(--text);
      font-size: 0.85rem;
    }

    .upload-fallback button {
      border-radius: 10px;
      border: none;
      padding: 0.6rem 0.75rem;
      background: rgba(123, 220, 255, 0.2);
      color: var(--accent-strong);
      cursor: pointer;
    }

    @media (min-width: 980px) {
      .app {
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(320px, 0.6fr);
        gap: 1.5rem;
        padding: 2rem;
      }

      .intel-panel {
        height: calc(100vh - 4rem);
        position: sticky;
        top: 2rem;
      }

      #intel-feed {
        overflow-y: auto;
        padding-right: 0.25rem;
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="stage" id="stage">
      <div class="placeholder" id="placeholder">
        Share a screenshot via the iOS Intelligence Hub shortcut to begin analysis.
        <div class="upload-fallback">
          <input type="file" id="imageInput" accept="image/*">
          <button id="loadSample">Use sample screenshot</button>
        </div>
      </div>
      <img id="screenshot" alt="Screenshot" hidden>
      <div class="scanning-overlay" id="scanningOverlay">
        <div class="scanner-bar" id="scannerBar"></div>
        <div class="scan-status">
          <h2>Analyzing Intent...</h2>
          <p>Hydrating intelligence feed</p>
        </div>
      </div>
    </section>

    <aside class="intel-panel">
      <div id="hero-slot" class="glass hero">
        <div class="hero-badge">Intelligence Hub</div>
        <div class="hero-title">Awaiting screenshot</div>
        <div class="hero-subtitle">Share an image to generate the dashboard.</div>
      </div>

      <div id="intel-feed"></div>

      <div id="footer-slot" class="glass">
        <div class="footer-actions">
          <button class="primary">Ask a follow-up</button>
          <button>Save report</button>
        </div>
        <div class="footer-note">Deprecated v1 experience available at /v1</div>
      </div>
    </aside>
  </div>

  <script>
    const screenshot = document.getElementById('screenshot');
    const placeholder = document.getElementById('placeholder');
    const scanningOverlay = document.getElementById('scanningOverlay');
    const scannerBar = document.getElementById('scannerBar');
    const heroSlot = document.getElementById('hero-slot');
    const intelFeed = document.getElementById('intel-feed');
    const footerSlot = document.getElementById('footer-slot');
    const imageInput = document.getElementById('imageInput');
    const loadSample = document.getElementById('loadSample');

    const stopScanner = () => {
      if (scannerBar) scannerBar.style.display = 'none';
      if (scanningOverlay) scanningOverlay.classList.add('fade-out');
    };

    const resetScanner = () => {
      if (scannerBar) scannerBar.style.display = 'block';
      if (scanningOverlay) scanningOverlay.classList.remove('fade-out');
    };

    const toolLibrary = {
      render_hero: (args) => {
        stopScanner();
        heroSlot.innerHTML = `
          <div class="hero-badge">${args.badge || 'Intent Detected'}</div>
          <div class="hero-title">${args.title || 'Screenshot Insight'}</div>
          <div class="hero-subtitle">${args.subtitle || 'AI analysis ready'}</div>
          ${args.hero_image ? `
            <div class="hero-image"><img src="${args.hero_image}" alt="Hero image"></div>
          ` : ''}
        `;
      },
      render_metric: (args) => {
        const card = document.createElement('div');
        card.className = 'intel-card';
        card.innerHTML = `
          <div style="font-size:0.8rem; color: var(--text-dim);">${args.label || ''}</div>
          <div class="metric-value" style="color:${args.color || 'var(--text)'};">${args.value || ''}</div>
          <div style="font-size:0.9rem; margin-top:0.5rem;">${args.title || ''}</div>
          ${args.subtext ? `<div class="metric-subtext">${args.subtext}</div>` : ''}
        `;
        intelFeed.appendChild(card);
      },
      render_list: (args) => {
        const card = document.createElement('div');
        card.className = 'intel-card';
        card.innerHTML = `
          <div style="font-weight:600; margin-bottom:0.5rem;">${args.title || ''}</div>
          ${Array.isArray(args.items) ? args.items.map(item => `
            <div class="list-item ${item.active ? 'active' : ''}">
              <span>${item.icon ? item.icon + ' ' : ''}${item.label || ''}</span>
              <span>${item.value || ''}</span>
            </div>
          `).join('') : ''}
        `;
        intelFeed.appendChild(card);
      },
      render_grid: (args) => {
        const card = document.createElement('div');
        card.className = 'intel-card';
        card.innerHTML = `
          <div class="grid">
            ${Array.isArray(args.cells) ? args.cells.map(cell => `
              <div class="grid-cell ${cell.dark_mode ? 'dark' : ''}">
                <div style="font-size:0.75rem; color: var(--text-dim);">${cell.label || ''}</div>
                <div style="margin-top:0.35rem; font-weight:600;">${cell.value || ''}</div>
              </div>
            `).join('') : ''}
          </div>
        `;
        intelFeed.appendChild(card);
      },
      render_footer: (args) => {
        footerSlot.innerHTML = `
          <div class="footer-actions">
            <button class="primary">${args.primary_btn?.icon ? args.primary_btn.icon + ' ' : ''}${args.primary_btn?.label || 'Continue'}</button>
            <button>${args.secondary_btn?.icon || 'â‹¯'}</button>
          </div>
          <div class="footer-note">${args.note || 'Dashboard hydrated from screenshot intelligence.'}</div>
        `;
      }
    };

    const applyToolCalls = (toolCalls = []) => {
      let delay = 0;
      toolCalls.forEach((call, index) => {
        const toolFn = toolLibrary[call.tool];
        if (!toolFn) return;
        const schedule = index === 0 ? 0 : (delay += 350);
        setTimeout(() => toolFn(call.args || {}), schedule);
      });
    };

    const decodeImageFromQuery = () => {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('image');
      if (!encoded) return null;
      try {
        return decodeURIComponent(encoded.replace(/ /g, '+'));
      } catch (err) {
        return encoded.replace(/ /g, '+');
      }
    };

    const setUrlImageParam = (dataUrl) => {
      if (!dataUrl) return;
      const encoded = encodeURIComponent(dataUrl);
      const newUrl = `${window.location.pathname}?image=${encoded}`;
      window.history.replaceState({}, '', newUrl);
    };

    const setScreenshot = (dataUrl) => {
      if (!dataUrl) return;
      screenshot.src = dataUrl.startsWith('data:') ? dataUrl : `data:image/png;base64,${dataUrl}`;
      screenshot.hidden = false;
      placeholder.style.display = 'none';
    };

    const analyzeScreenshot = async (payload) => {
      try {
        const response = await fetch('/api/hub/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || 'Analysis failed');
        }
        intelFeed.innerHTML = '';
        applyToolCalls(data.toolCalls || []);
      } catch (error) {
        stopScanner();
        heroSlot.innerHTML = `
          <div class="hero-badge">Analysis unavailable</div>
          <div class="hero-title">${error.message || 'Unable to analyze screenshot'}</div>
          <div class="hero-subtitle">Check API configuration and try again.</div>
        `;
      }
    };

    const loadSampleImage = async () => {
      const response = await fetch('/api/hub/sample');
      const data = await response.json();
      if (response.ok && data.dataUrl) {
        return data.dataUrl;
      }
      throw new Error('No sample image available');
    };

    const bootstrap = async () => {
      const imageParam = decodeImageFromQuery();
      if (imageParam) {
        setScreenshot(imageParam);
        resetScanner();
        analyzeScreenshot({ image: imageParam });
        return;
      }
      stopScanner();
    };

    imageInput.addEventListener('change', () => {
      const file = imageInput.files && imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        setScreenshot(reader.result);
        setUrlImageParam(reader.result);
        resetScanner();
        analyzeScreenshot({ image: reader.result });
      };
      reader.readAsDataURL(file);
    });

    loadSample.addEventListener('click', async () => {
      try {
        const dataUrl = await loadSampleImage();
        setScreenshot(dataUrl);
        setUrlImageParam(dataUrl);
        resetScanner();
        analyzeScreenshot({ image: dataUrl });
      } catch (error) {
        heroSlot.innerHTML = `
          <div class="hero-badge">Sample error</div>
          <div class="hero-title">${error.message}</div>
          <div class="hero-subtitle">Check /screens for sample files.</div>
        `;
      }
    });

    bootstrap();
  </script>
</body>
</html>
